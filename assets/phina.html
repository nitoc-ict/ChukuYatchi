<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src='http://cdn.rawgit.com/phi-jp/phina.js/v0.2.0/build/phina.js'></script>
<script>
// phina.js をグローバル領域に展開
phina.globalize();

// MainScene クラスを定義

/*
 * メインシーン
 */

var MAX_ROOF_WIDTH = 10;
var MAX_ROOF_HEIGHT = 3;
var TILE_WIDTH = 80;
var TILE_HEIGHT = 50;
var TILE_MARGIN = 8;

phina.define("MainScene", {
    superClass: "DisplayScene",
    init: function () {
      this.superInit();


      // プレイヤー
      this.player = RectangleShape({
          width: 100,
          height: 100,
          fill: "gray",
          stroke: null
      }).addChildTo(this).setPosition(this.gridX.center(), this.gridY.center());
      this.flick = this.player.flickable;
      this.flick.horizontal = false;

      this.roof = DisplayElement().addChildTo(this);
      (MAX_ROOF_HEIGHT * MAX_ROOF_WIDTH).times(function(i) {
        let x = i % MAX_ROOF_WIDTH;
        let y = Math.floor(i / MAX_ROOF_WIDTH);
        let tile = Tile().addChildTo(this.roof).setPosition(x * (TILE_WIDTH + TILE_MARGIN), 100 + y * (TILE_HEIGHT + TILE_MARGIN));
      }, this);

      this.label = Label(this.roof.children.length).addChildTo(this);

      this.label.x = 320;
      this.label.y = 480;
      this.label.fontSize = 42;

      this.roof.update = function(app) {
        var accel = app.accelerometer;
        // 重力情報
        var gravity = accel.gravity;
        var ori = accel.orientation;
        var rotate = accel.rotation;
      }

    },
    // 更新
    update: function (app) {
      if (this.player.y <= -10) {
          this.player.y = 960;
      } else if (this.player.y >= 970) {
          this.player.y = 0;
      }

      // フリックの強さ
      const len = Math.floor(this.flick.velocity.y);

      if (len > 20 || len < -20) {
          // フリックの方向
          const deg = (len < 0) ? 90 : 270;
      }

      this.checkHit();

      var accel = app.accelerometer;
      // 重力情報
      var gravity = accel.gravity;
      var ori = accel.orientation;
      var rotate = accel.rotation;
      window.addEventListener('deviceorientation', (dat) => {
        alpha = dat.alpha;

        var dx;
        if (alpha > 180) {
          dx = alpha - 360;
        }
        else {
          dx = alpha;
        }

        let i = 0;
        this.roof.children.each(function(tile) {
          let x = i % MAX_ROOF_WIDTH;
          tile.x = x * (TILE_WIDTH + TILE_MARGIN) + dx * 4;
          ++i;
        });
      });
    },

    checkHit: function() {
      var player = this.player;
      this.roof.children.each(function(tile) {
        if (tile.hitTestElement(player)) {
          tile.fill = 'red';
        }
        else {
          tile.fill = 'blue';
        }
      });
    },
});

phina.define('Tile', {
  superClass: 'RectangleShape',

  init: function() {
    this.superInit({
      width: TILE_WIDTH,
      height: TILE_HEIGHT,
      stroke: '#aaa',
      strokeWidth: 4,
      fill: 'blue',
      cornerRadius: 4,
    });
  }
});

// メイン処理
phina.main(function() {
  // アプリケーション生成
  var app = GameApp({
    startLabel: 'main', // メインシーンから開始する
  });
  // アプリケーション実行
  app.run();
});

</script>
