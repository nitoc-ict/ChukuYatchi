<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pizzicato/0.6.4/Pizzicato.min.js"></script>
    <script type="text/javascript" src='https://cdn.rawgit.com/phi-jp/phina.js/v0.2.0/build/phina.js'></script>

    <title>ChukuYatchi</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script>
      var audioContext;
      var mediaStreamSource = null
      var meter = null
      var volume = null;
      var gameScore = 0;

      function beginDetect() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)()
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({audio: true}).then((stream) => {
            mediaStreamSource = audioContext.createMediaStreamSource(stream)
            meter = createAudioMeter(audioContext)
            mediaStreamSource.connect(meter)
          })
        }
      }

      function createAudioMeter(audioContext, clipLevel, averaging, clipLag) {
        const processor = audioContext.createScriptProcessor(512)
        processor.onaudioprocess = volumeAudioProcess
        processor.clipping = false
        processor.lastClip = 0
        processor.volume = 0
        processor.clipLevel = clipLevel || 0.98
        processor.averaging = averaging || 0.95
        processor.clipLag = clipLag || 750

        // this will have no effect, since we don't copy the input to the output,
        // but works around a current Chrome bug.
        processor.connect(audioContext.destination)

        processor.checkClipping = function () {
          if (!this.clipping) {
            return false
          }
          if ((this.lastClip + this.clipLag) < window.performance.now()) {
            this.clipping = false
          }
          return this.clipping
        }

        processor.shutdown = function () {
          this.disconnect()
          this.onaudioprocess = null
        }

        return processor
      }

      function volumeAudioProcess(event) {
        const buf = event.inputBuffer.getChannelData(0)
        const bufLength = buf.length
        let sum = 0
        let x

        // Do a root-mean-square on the samples: sum up the squares...
        for (var i = 0; i < bufLength; i++) {
          x = buf[i]
          if (Math.abs(x) >= this.clipLevel) {
              this.clipping = true
              this.lastClip = window.performance.now()
          }
          sum += x * x
        }

        // ... then take the square root of the sum.
        const rms = Math.sqrt(sum / bufLength)

        // Now smooth this out with the averaging factor applied
        // to the previous sample - take the max here because we
        // want "fast attack, slow release."
        this.volume = Math.max(rms, this.volume * this.averaging)
        volume = this.volume;
//        document.getElementById('audio-value').innerHTML = volume
//        document.getElementById('score-value').innerHTML = gameScore
      }

      console.log(volume);

      phina.globalize();
      // 定数
      const ASSETS = {
        image: {
          uchiwa: 'https://drive.google.com/uc?id=1xXLdSzMglC8iLn0moIzIZ-KH16GDNcfI',
          uchiwa2: 'https://drive.google.com/uc?id=1S4EcNFIzlEmLtqt8m4HZLKhNufULcd_9',
          kamado: 'https://drive.google.com/uc?id=1JFX4Im7h_gyubtJR3BReKeEawmbWHl0A',
          fire1: 'https://drive.google.com/uc?id=1NehPRUijw0gZ9J4QLh6VRl73YIrrxQBs',
          fire2: 'https://drive.google.com/uc?id=1keye0H-z1pgZGpnH629B0JUYg-yQwbzb',
          fire3: 'https://drive.google.com/uc?id=1QLQGhZd_LmhS7Um7543OPSIesMVdd0_F',
          fire4: 'https://drive.google.com/uc?id=1Xttjt0A0PKuGec9_Q1ow9_DIQ7kE1x8t',
          back: 'https://drive.google.com/uc?id=1NKrSV77pmY_y-orZjL9IrgYp58W4NdvA'
        },
      };
      // 画面の解像度
      const SCREEN_WIDTH  = window.parent.screen.width * 1.77;
      const SCREEN_HEIGHT = window.parent.screen.height * 1.77;
      // const SCREEN_WIDTH  = 1080;
      // const SCREEN_HEIGHT = 1920;

      // アプリ(ブラウザ)の表示領域サイズ 1.78 is magic number
      const WINDOW_WIDTH = window.innerWidth * 1.77;
      const WINDOW_HEIGHT = window.innerHeight* 1.77;
      var switchChar = true;

      // const SPEED         = 10;
      phina.define("MainScene", {
        superClass: 'CanvasScene',
        init: function(options) {
          this.superInit(options);
      beginDetect();  // load時からvolumeを取る
          this.background = Sprite('kamado').setPosition(this.gridX.center(), this.gridY.center()).addChildTo(this);

          this.fire1 = Sprite('fire1', 128, 256).setPosition(this.gridX.center(), this.gridY.center()).addChildTo(this);
          this.fire2 = Sprite('fire2', 128, 256).setPosition(this.gridX.center(), this.gridY.center()).addChildTo(this).hide();
          this.fire3 = Sprite('fire3', 128, 256).setPosition(this.gridX.center(), this.gridY.center()).addChildTo(this).hide();
          this.fire4 = Sprite('fire4', 128, 256).setPosition(this.gridX.center(), this.gridY.center()).addChildTo(this).hide();
          // fireの切り替え
          this.ch = [this.fire1, this.fire2, this.fire3, this.fire4];

          this.uchiwa = Sprite('uchiwa', 128, 256).setPosition(this.gridX.center()+120, this.gridY.center()+150).addChildTo(this);
          this.uchiwa2 = Sprite('uchiwa2', 128, 256).setPosition(this.gridX.center()+120, this.gridY.center()+150).addChildTo(this);

          // 戻るボタン
          this.back = Sprite('back').addChildTo(this);
          this.back.x = this.gridX.span(3);
          this.back.y = this.gridY.span(15);
          this.back.setInteractive(true);

          // もどるアイコンをタップしたときの処理
          var own = this;
          this.back.onpointstart = function() {
            madeTiles = parseInt(localStorage.getItem("made_tile_number"));
            localStorage.setItem("made_tile_number", madeTiles + gameScore / 10);
            own.exit('main');
          };
        },
        update: function() {
          // うちわの切り替え
          switchChar = !switchChar
          if (switchChar) {
            this.uchiwa.hide();
            this.uchiwa2.show();
          } else {
            this.uchiwa.show();
            this.uchiwa2.hide();
          }

          if (0.4 < volume) {
            gameScore += 1;
            this.ch[0].hide();
            this.ch[1].hide();
            this.ch[+ switchChar + 2].hide();
            this.ch[+ !switchChar + 2].show();
          } else {
            this.ch[2].hide();
            this.ch[3].hide();
            this.ch[+ switchChar].hide();
            this.ch[+ !switchChar].show();
          }
        }
      });
      /*
       * メイン処理
       */
      phina.main(function() {
        // アプリケーションを生成
        var app = GameApp({
          startLabel: 'main',   // MainScene から開始
           width: WINDOW_WIDTH,  // 画面幅
           height: WINDOW_HEIGHT,// 画面高さ
          assets: ASSETS,       // アセット読み込み
        });
        app.enableStats();
       // 実行
        app.run();
      });
    </script>
  </body>
</html>
